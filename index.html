if (window.DeviceMotionEvent) {
  window.addEventListener("devicemotion", (event) => {
    const acc = event.accelerationIncludingGravity;
    const now = Date.now();
    if (!lastUpdateTime || !imuLat || !imuLon) {
      lastUpdateTime = now;
      return;
    }

    const dt = (now - lastUpdateTime) / 1000;
    lastUpdateTime = now;

    // --- 加速度の大きさ ---
    const accMag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

    // --- ステップ検出（ピーク判定） ---
    if (accMag - lastAccMag > STEP_THRESHOLD && now - lastStepTime > 300) {
      stepCount++;
      stepDetected = true;
      stepInterval = (now - lastStepTime) / 1000;
      lastStepTime = now;
      lastMoveTime = now;

      // 歩行速度 = 歩幅 ÷ ステップ間隔
      currentSpeed = STEP_LENGTH / stepInterval;
      // 速度を4〜8km/hの範囲に制限
      currentSpeed = Math.min(Math.max(currentSpeed, 1.1), 2.2);
    } else {
      stepDetected = false;
    }

    lastAccMag = accMag;

    // --- 停止判定 ---
    if (now - lastMoveTime > 2000) { // 2秒間ステップなし
      currentSpeed = 0;
    }

    // --- 位置更新 ---
    if (currentSpeed > 0 && heading && imuLat && imuLon) {
      const distance = currentSpeed * dt;
      const dLat = (distance * Math.cos(heading * Math.PI / 180)) / 111111;
      const dLon = (distance * Math.sin(heading * Math.PI / 180)) / (111111 * Math.cos(imuLat * Math.PI / 180));
      imuLat += dLat;
      imuLon += dLon;
      checkProximity(imuLat, imuLon);
    }
  });
}
