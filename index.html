<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>IMUçµ±åˆç‰ˆï¼šè¤‡æ•°ç”»åƒåˆ‡æ›¿ä»˜ãã‚¹ãƒãƒƒãƒˆæ¡ˆå†…ï¼ˆè‡ªå‹•éŸ³å£°ç‰ˆï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: sans-serif;
            text-align: center;
        }

        #camera {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 1;
            white-space: pre-wrap;
        }

        #image {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            object-fit: contain;
            display: none;
            z-index: 1;
            background: black;
        }

        .btn {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 2;
            display: none;
        }

        #patternBtn {
            bottom: 70px;
        }

        #nextBtn {
            bottom: 20px;
        }

        .img-nav {
            position: absolute;
            bottom: 260px;
            z-index: 2;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 6px;
        }

        #prevBtn {
            left: 10%;
        }

        #nextImgBtn {
            right: 10%;
        }
    </style>
</head>

<body>

    <video id="camera" autoplay playsinline muted></video>
    <div id="info">ä½ç½®æƒ…å ±ãƒ»IMUå–å¾—ä¸­...</div>
    <img id="image" src="" alt="ã‚¹ãƒãƒƒãƒˆç”»åƒ" />
    <button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
    <button class="btn" id="nextBtn" onclick="goToNextSpot()">ã“ã®ã‚¹ãƒãƒƒãƒˆã¯å®Œäº†</button>
    <button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">â†</button>
    <button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">â†’</button>
    <audio id="audio" src=""></audio>

    <script>
        const spots = [
            { name: "13å·é¤¨å‰", lat: 35.69302425885399, lon: 140.0508424409975, radius: 0, images: ["image0.jpeg", "image1.jpeg"], audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" } },
            { name: "æ›²ãŒã‚Šè§’å³", lat: 35.69283234340133, lon: 140.05091587321536, radius: 20, images: ["image3.jpeg", "image11.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } },
            { name: "æ›²ãŒã‚Šè§’å³ï¼‘", lat: 35.69286877921128, lon: 140.05030279528978, radius: 20, images: ["image4.jpeg", "image13.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } },
            { name: "æ›²ãŒã‚Šè§’å³ï¼’", lat: 35.69334894066289, lon: 140.05033682451656, radius: 20, images: ["image5.jpeg", "image14.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } },
            { name: "æ›²ãŒã‚Šè§’å³ï¼“", lat: 35.69331981781718, lon: 140.05102244720183, radius: 20, images: ["image6.jpeg", "image15.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } },
            { name: "ç›®çš„åœ°", lat: 35.693014464267506, lon: 140.0509410980045, radius: 20, images: ["image7.jpeg", "image16.jpeg"], audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" } }
        ];

        let currentIndex = 0;
        let hasEnteredSpot = false;
        let currentSpot = null;
        let currentPattern = "A";
        let imageIndex = 0;

        let stepCount = 0;
        let lastStepTime = 0;
        let stepDetected = false;
        let lastAccMag = 0; let stepInterval = 0;
        let lastMoveTime = Date.now();
        const STEP_LENGTH = 0.7; // 1æ­©ã‚ãŸã‚Š0.7m
        const STEP_THRESHOLD = 1.2; // åŠ é€Ÿåº¦å¤‰åŒ–ã®ã—ãã„å€¤
        let currentSpeed = 0;

        let lastUpdateTime = null;
        let velocity = { x: 0, y: 0, z: 0 };
        let imuLat = null, imuLon = null;
        let heading = 0; // æ–¹ä½ï¼ˆåº¦ï¼‰

        const camera = document.getElementById("camera");
        const info = document.getElementById("info");
        const image = document.getElementById("image");
        const nextBtn = document.getElementById("nextBtn");
        const patternBtn = document.getElementById("patternBtn");
        const audio = document.getElementById("audio");
        const prevBtn = document.getElementById("prevBtn");
        const nextImgBtn = document.getElementById("nextImgBtn");
        
        /* ---------------- â˜…URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹åˆæœŸã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ---------------- */
            const urlParams = new URLSearchParams(window.location.search);
            const qrLat = parseFloat(urlParams.get("lat"));
            const qrLon = parseFloat(urlParams.get("lon"));

            if (!isNaN(qrLat) && !isNaN(qrLon)) {
                imuLat = qrLat;
                imuLon = qrLon;
                console.log("âœ… QRã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆæœŸä½ç½®è£œæ­£:", imuLat, imuLon);
                // info.innerText ã®è¡¨ç¤ºã¯å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¦‹ã›ãªã„ï¼‰
            }

        /* ---------------- ã‚«ãƒ¡ãƒ©èµ·å‹• ---------------- */
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
            .then(stream => camera.srcObject = stream)
            .catch(err => alert("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err));

        /* ---------------- è·é›¢è¨ˆç®—ï¼ˆhaversineï¼‰ ---------------- */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        /* ---------------- ã‚¹ãƒãƒƒãƒˆåˆ¤å®š ---------------- */
        function checkProximity(lat, lon) {
                let targetIndex = currentIndex;

                // ã‚¹ãƒãƒƒãƒˆ1å®Œäº†å¾Œã¯å¸¸ã«æ¬¡ã®ã‚¹ãƒãƒƒãƒˆåˆ¤å®š
                if (currentIndex === 0 && hasEnteredSpot) {
                    targetIndex = 1;
                }

                if (targetIndex >= spots.length) {
                    info.innerText = "ã™ã¹ã¦ã®ã‚¹ãƒãƒƒãƒˆã‚’é€šéã—ã¾ã—ãŸã€‚";
                    hideAllUI();
                    return;
                }

                const spot = spots[targetIndex];
                const distance = getDistance(lat, lon, spot.lat, spot.lon);
                const range = spot.radius || 10;

                info.innerText =
                    `IMUè£œæ­£ä½ç½®: ç·¯åº¦ ${lat.toFixed(6)}, çµŒåº¦ ${lon.toFixed(6)}\n` +
                    `æ¬¡ã®ã‚¹ãƒãƒƒãƒˆ: ${spot.name}ï¼ˆ${targetIndex + 1} / ${spots.length}ï¼‰\n` +
                    `æ®‹ã‚Šè·é›¢: ${distance.toFixed(1)}m\n`;

                // æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã«åˆ°é”ã—ãŸã‚‰è¡¨ç¤º
                if (!hasEnteredSpot && distance < range) {
                    showSpot(spot);
                }
            }


        /* ---------------- ã‚¹ãƒãƒƒãƒˆè¡¨ç¤º ---------------- */
        function showSpot(spot) {
            currentSpot = spot;
            hasEnteredSpot = true;
            imageIndex = 0;

            audio.src = spot.audio[currentPattern];
            image.src = spot.images[imageIndex];
            image.style.display = "block";
            nextBtn.style.display = "block";
            patternBtn.style.display = "block";
            prevBtn.style.display = spot.images.length > 1 ? "block" : "none";
            nextImgBtn.style.display = spot.images.length > 1 ? "block" : "none";

            audio.loop = true;
            audio.play().catch(e => console.log("è‡ªå‹•å†ç”Ÿã«å¤±æ•—:", e));
        }

        /* ---------------- éŸ³å£°ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿ ---------------- */
        function switchPattern() {
            const patterns = ["A", "B", "C"];
            const index = patterns.indexOf(currentPattern);
            currentPattern = patterns[(index + 1) % patterns.length];
            updatePatternButtonText();

            if (currentSpot) {
                audio.pause();
                audio.src = currentSpot.audio[currentPattern];
                audio.play().catch(e => console.log("è‡ªå‹•å†ç”Ÿã«å¤±æ•—:", e));
            }
        }

        function updatePatternButtonText() {
            patternBtn.innerText = currentPattern === "A" ? "English" : currentPattern === "B" ? "ä¸­æ–‡" : "æ—¥æœ¬èª";
        }

        /* ---------------- ç”»åƒåˆ‡æ›¿ ---------------- */
        function showPrevImage() {
            if (!currentSpot) return;
            imageIndex = (imageIndex - 1 + currentSpot.images.length) % currentSpot.images.length;
            image.src = currentSpot.images[imageIndex];
        }
        function showNextImage() {
            if (!currentSpot) return;
            imageIndex = (imageIndex + 1) % currentSpot.images.length;
            image.src = currentSpot.images[imageIndex];
        }

        /* ---------------- æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¸ ---------------- */
        function goToNextSpot() {
            audio.pause();
            currentIndex = Math.max(currentIndex, 1);
            hasEnteredSpot = false;
            currentSpot = null;
            hideAllUI();
        }

        /* ---------------- UI éè¡¨ç¤º ---------------- */
        function hideAllUI() {
            image.style.display = "none";
            nextBtn.style.display = "none";
            patternBtn.style.display = "none";
            prevBtn.style.display = "none";
            nextImgBtn.style.display = "none";
        }

        /* ---------------- IMUï¼ˆåŠ é€Ÿåº¦ï¼‹æ–¹ä½ï¼‰ ---------------- */
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", (event) => {
                if (event.absolute && event.alpha != null) {
                    heading = 360 - event.alpha; // åŒ—ã‚’0Â°ã¨ã—ãŸæ–¹ä½
                }
            });
        }
        if (window.DeviceMotionEvent) {
            window.addEventListener("devicemotion", (event) => {
                const acc = event.accelerationIncludingGravity;
                const now = Date.now();
                if (!lastUpdateTime || !imuLat || !imuLon) {
                    lastUpdateTime = now;
                    return;
                }

                const dt = (now - lastUpdateTime) / 1000;
                lastUpdateTime = now;

                // --- åŠ é€Ÿåº¦ã®å¤§ãã• ---
                const accMag = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);

                // --- ã‚¹ãƒ†ãƒƒãƒ—æ¤œå‡ºï¼ˆãƒ”ãƒ¼ã‚¯åˆ¤å®šï¼‰ ---
                if (accMag - lastAccMag > STEP_THRESHOLD && now - lastStepTime > 300) {
                    stepCount++;
                    stepDetected = true;
                    stepInterval = (now - lastStepTime) / 1000;
                    lastStepTime = now;
                    lastMoveTime = now;

                    // æ­©è¡Œé€Ÿåº¦ = æ­©å¹… Ã· ã‚¹ãƒ†ãƒƒãƒ—é–“éš”
                    currentSpeed = STEP_LENGTH / stepInterval;
                    // é€Ÿåº¦ã‚’4ã€œ8km/hã®ç¯„å›²ã«åˆ¶é™
                    currentSpeed = Math.min(Math.max(currentSpeed, 1.1), 2.2);
                } else {
                    stepDetected = false;
                }

                lastAccMag = accMag;

                // --- åœæ­¢åˆ¤å®š ---
                if (now - lastMoveTime > 2000) { // 2ç§’é–“ã‚¹ãƒ†ãƒƒãƒ—ãªã—
                    currentSpeed = 0;
                }

                // --- ä½ç½®æ›´æ–° ---
                if (currentSpeed > 0 && heading && imuLat && imuLon) {
                    const distance = currentSpeed * dt;
                    const dLat = (distance * Math.cos(heading * Math.PI / 180)) / 111111;
                    const dLon = (distance * Math.sin(heading * Math.PI / 180)) / (111111 * Math.cos(imuLat * Math.PI / 180));
                    imuLat += dLat;
                    imuLon += dLon;
                    checkProximity(imuLat, imuLon);
                }
            });
        }


        /* ---------------- GPS ---------------- */
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    // âœ… QRã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆæœŸè£œæ­£ãŒã€Œã¾ã ãªã„ã¨ãã€ã ã‘GPSå€¤ã‚’ä½¿ã†
                    if (!imuLat || !imuLon) {
                        imuLat = pos.coords.latitude;
                        imuLon = pos.coords.longitude;
                    }
                    lastUpdateTime = Date.now();
                    checkProximity(imuLat, imuLon);
                },
                err => {
                    console.warn("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—:", err);
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

         window.onload = () => {
            updatePatternButtonText();

            const urlParams = new URLSearchParams(window.location.search);
            const qrLat = parseFloat(urlParams.get("lat"));
            const qrLon = parseFloat(urlParams.get("lng") || urlParams.get("lon")); // ä¸¡æ–¹å¯¾å¿œ
            const qrName = urlParams.get("name");

            if (!isNaN(qrLat) && !isNaN(qrLon)) {
                // âœ… QRã‚³ãƒ¼ãƒ‰åº§æ¨™ã§åˆæœŸã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                imuLat = qrLat;
                imuLon = qrLon;
                currentLat = qrLat;
                currentLon = qrLon;

                console.log("âœ… QRã‚³ãƒ¼ãƒ‰è£œæ­£å®Œäº†:", imuLat, imuLon);

                const spot = spots[0];
                info.innerText =
                    `ğŸ“IMUè£œæ­£ä½ç½®: ç·¯åº¦ ${imuLat.toFixed(6)}, çµŒåº¦ ${imuLon.toFixed(6)}\n` +
                    `ç¾åœ¨åœ°: ${spot.name}ï¼ˆ1 / ${spots.length}ï¼‰\næ®‹ã‚Šè·é›¢: 0.0m`;

                // âœ… ã‚¹ãƒãƒƒãƒˆåãŒURLã«ä¸€è‡´ã™ã‚‹å ´åˆã¯ãã®ã‚¹ãƒãƒƒãƒˆã‚’å³è¡¨ç¤º
                if (qrName && spots.find(s => s.name === qrName)) {
                    const targetSpot = spots.find(s => s.name === qrName);
                    showSpot(targetSpot);
                } else {
                    showSpot(spot);
                }
            } else {
                info.innerText = "åˆæœŸä½ç½®å–å¾—ä¸­...";
            }
        };

    </script>

</body>

</html>
